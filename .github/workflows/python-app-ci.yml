# This workflow will install Python dependencies, run tests and lint with a single version of Python
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-python

name: Python application CI

on:
  push:
    branches: [ "master" ]
  pull_request:
    branches: [ "master" ]

permissions:
  contents: write
  pull-requests: write

jobs:
  build:

    runs-on: ubuntu-latest

    steps:
    - name: Check out repository
      uses: actions/checkout@v4
    - name: Install the latest version of uv
      uses: astral-sh/setup-uv@v6
      with:
        version: "latest"
        python-version: 3.12.3
        enable-cache: true
        ignore-nothing-to-cache: true
    - name: Run ruff
      run: uv run ruff check .
    - name: Lint with flake8
      run: |
        # stop the build if there are Python syntax errors or undefined names
        uv run flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics --exclude .venv
        # exit-zero treats all errors as warnings. The GitHub editor is 127 chars wide
        uv run flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics --exclude .venv
    - name: Test with pytest and coverage with pytest-cov
      run: |
        uv run pytest --cov
    - name: Pytest coverage html report
      run: |
        uv run pytest --cov-report html --cov
    - uses: actions/upload-artifact@v4
      with:
        name: coverage-report
        path: htmlcov
    - name: MyPy
      run: |
        uv run mypy --disallow-untyped-calls --disallow-untyped-defs --disallow-incomplete-defs src
    - name: Install coveralls-python
      run: uv run pip install coveralls
    - name: Run coveralls
      run: coveralls --service=github-actions
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
  auto-merge:
    if: |
      startsWith(github.event.pull_request.title, 'Bump version to v') &&
      (
        github.actor == 'github-actions[bot]' ||
        github.actor == github.repository_owner
      )
    runs-on: ubuntu-latest
    steps:
      - name: Auto-merge PR
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            if (
              ( pr.user.login === 'github-actions[bot]' || pr.user.login === 'casperlehmann' ) &&
              pr.title.startsWith('Bump version to v')
            ) {
              await github.rest.pulls.merge({
                owner: context.repo.owner,
                repo: context.repo.repo,
                pull_number: pr.number,
                merge_method: 'squash'
              });
              console.log(`✅ Auto-merged PR #${pr.number}`);
            } else {
              console.log(`pr.user.login: ${pr.user.login} ${( pr.user.login === 'github-actions[bot]' || pr.user.login === 'casperlehmann' ) ? '✅' : '❌'}`);
              console.log(`pr.title: ${pr.title} ${pr.title.startsWith('Bump version to v') ? '✅' : '❌'}`);
              console.log(`ℹ️ Skipping auto-merge for PR #${pr.number}`);
            }
